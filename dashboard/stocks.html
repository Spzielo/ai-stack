<!DOCTYPE html>
<html lang="fr">

<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Stocks One-Glance</title>
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="style.css">
      <style>
            .crypto-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 2rem;
            }

            .update-btn {
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white;
                  border: none;
                  padding: 12px 24px;
                  border-radius: 12px;
                  font-size: 16px;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }

            .update-btn:hover {
                  transform: translateY(-2px);
                  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            }

            .update-btn:disabled {
                  opacity: 0.6;
                  cursor: not-allowed;
            }

            .status-bar {
                  background: rgba(255, 255, 255, 0.05);
                  border: 1px solid rgba(255, 255, 255, 0.1);
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 2rem;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
            }

            .status-item {
                  text-align: center;
            }

            .status-label {
                  font-size: 12px;
                  color: rgba(255, 255, 255, 0.6);
                  margin-bottom: 4px;
            }

            .status-value {
                  font-size: 20px;
                  font-weight: 700;
                  color: white;
            }

            .crypto-grid {
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                  gap: 1.5rem;
                  margin-top: 2rem;
            }

            .crypto-card {
                  background: rgba(255, 255, 255, 0.05);
                  border: 1px solid rgba(255, 255, 255, 0.1);
                  border-radius: 16px;
                  padding: 20px;
                  transition: all 0.3s ease;
            }

            .crypto-card:hover {
                  background: rgba(255, 255, 255, 0.08);
                  border-color: rgba(255, 255, 255, 0.2);
                  transform: translateY(-4px);
            }

            .crypto-symbol {
                  font-size: 24px;
                  font-weight: 700;
                  margin-bottom: 8px;
            }

            .crypto-name {
                  font-size: 14px;
                  color: rgba(255, 255, 255, 0.6);
                  margin-bottom: 16px;
            }

            .crypto-price {
                  font-size: 28px;
                  font-weight: 700;
                  color: #667eea;
                  margin-bottom: 12px;
            }

            .crypto-score {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-top: 12px;
                  padding-top: 12px;
                  border-top: 1px solid rgba(255, 255, 255, 0.1);
            }

            .score-value {
                  font-size: 18px;
                  font-weight: 700;
            }

            .status-badge {
                  padding: 4px 12px;
                  border-radius: 20px;
                  font-size: 12px;
                  font-weight: 600;
            }

            .status-accumuler {
                  background: rgba(34, 197, 94, 0.2);
                  color: #22c55e;
            }

            .status-observer {
                  background: rgba(251, 191, 36, 0.2);
                  color: #fbbf24;
            }

            .status-riskoff {
                  background: rgba(239, 68, 68, 0.2);
                  color: #ef4444;
            }

            .loading {
                  text-align: center;
                  padding: 40px;
                  color: rgba(255, 255, 255, 0.6);
            }

            .spinner {
                  border: 3px solid rgba(255, 255, 255, 0.1);
                  border-top: 3px solid #667eea;
                  border-radius: 50%;
                  width: 40px;
                  height: 40px;
                  animation: spin 1s linear infinite;
                  margin: 0 auto 16px;
            }

            @keyframes spin {
                  0% {
                        transform: rotate(0deg);
                  }

                  100% {
                        transform: rotate(360deg);
                  }
            }

            .back-btn {
                  display: inline-block;
                  color: rgba(255, 255, 255, 0.6);
                  text-decoration: none;
                  margin-bottom: 2rem;
                  transition: color 0.3s ease;
            }

            .back-btn:hover {
                  color: white;
            }

            /* Override body alignment from style.css */
            body {
                  align-items: flex-start !important;
                  overflow-y: auto !important;
                  padding: 2rem 0;
            }

            .container {
                  width: 100%;
                  max-width: 1400px;
                  margin: 0 auto;
                  padding: 0 2rem;
            }

            /* Filters */
            .filters-bar {
                  background: rgba(255, 255, 255, 0.05);
                  border: 1px solid rgba(255, 255, 255, 0.1);
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 2rem;
                  display: flex;
                  gap: 16px;
                  flex-wrap: wrap;
                  align-items: center;
            }

            .filter-group {
                  display: flex;
                  align-items: center;
                  gap: 8px;
            }

            .filter-group label {
                  font-size: 14px;
                  color: rgba(255, 255, 255, 0.7);
                  font-weight: 500;
            }

            .filter-group select,
            .filter-group input {
                  background: rgba(255, 255, 255, 0.1);
                  border: 1px solid rgba(255, 255, 255, 0.2);
                  border-radius: 8px;
                  padding: 8px 12px;
                  color: white;
                  font-size: 14px;
                  min-width: 150px;
            }

            .search-group input {
                  min-width: 200px;
            }

            .filter-group select:focus,
            .filter-group input:focus {
                  outline: none;
                  border-color: #667eea;
            }

            /* Portfolio Summary */
            .portfolio-summary {
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                  gap: 1rem;
                  margin-bottom: 2rem;
                  padding: 1.5rem;
                  background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
                  border: 1px solid rgba(102, 126, 234, 0.3);
                  border-radius: 12px;
            }

            .summary-card {
                  text-align: center;
                  padding: 1rem;
                  background: rgba(255, 255, 255, 0.05);
                  border-radius: 8px;
                  transition: transform 0.2s ease;
            }

            .summary-card:hover {
                  transform: translateY(-2px);
            }

            .summary-card.positive {
                  background: rgba(16, 185, 129, 0.1);
                  border: 1px solid rgba(16, 185, 129, 0.3);
            }

            .summary-card.negative {
                  background: rgba(239, 68, 68, 0.1);
                  border: 1px solid rgba(239, 68, 68, 0.3);
            }

            .summary-label {
                  font-size: 14px;
                  color: rgba(255, 255, 255, 0.7);
                  margin-bottom: 8px;
            }

            .summary-value {
                  font-size: 24px;
                  font-weight: 700;
                  color: white;
            }

            .summary-card.positive .summary-value {
                  color: #10b981;
            }

            .summary-card.negative .summary-value {
                  color: #ef4444;
            }

            /* Position indicator on crypto cards */
            .position-indicator {
                  margin-top: 12px;
                  padding: 8px;
                  background: rgba(102, 126, 234, 0.1);
                  border-left: 3px solid #667eea;
                  border-radius: 4px;
                  font-size: 12px;
            }

            .position-indicator .invested {
                  color: rgba(255, 255, 255, 0.6);
                  margin-bottom: 4px;
            }

            .position-indicator .current {
                  color: rgba(255, 255, 255, 0.8);
                  margin-bottom: 4px;
            }

            .position-indicator .profit {
                  font-weight: 600;
            }

            .position-indicator .profit.positive {
                  color: #10b981;
            }

            .position-indicator .profit.negative {
                  color: #ef4444;
            }

            /* Modal for adding positions */
            .modal {
                  display: none;
                  position: fixed;
                  z-index: 1000;
                  left: 0;
                  top: 0;
                  width: 100%;
                  height: 100%;
                  background-color: rgba(0, 0, 0, 0.7);
                  backdrop-filter: blur(5px);
            }

            .modal-content {
                  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                  margin: 5% auto;
                  padding: 2rem;
                  border: 1px solid rgba(102, 126, 234, 0.3);
                  border-radius: 16px;
                  width: 90%;
                  max-width: 500px;
                  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            }

            .modal-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 1.5rem;
            }

            .modal-header h2 {
                  color: white;
                  margin: 0;
            }

            .close-btn {
                  color: rgba(255, 255, 255, 0.6);
                  font-size: 28px;
                  font-weight: bold;
                  cursor: pointer;
                  transition: color 0.3s ease;
            }

            .close-btn:hover {
                  color: white;
            }

            .form-group {
                  margin-bottom: 1.5rem;
            }

            .form-group label {
                  display: block;
                  color: rgba(255, 255, 255, 0.8);
                  margin-bottom: 0.5rem;
                  font-size: 14px;
            }

            .form-group input,
            .form-group select,
            .form-group textarea {
                  width: 100%;
                  padding: 12px;
                  background: rgba(255, 255, 255, 0.1);
                  border: 1px solid rgba(255, 255, 255, 0.2);
                  border-radius: 8px;
                  color: white;
                  font-size: 14px;
                  box-sizing: border-box;
            }

            .form-group input:focus,
            .form-group select:focus,
            .form-group textarea:focus {
                  outline: none;
                  border-color: #667eea;
            }

            .btn {
                  padding: 12px 24px;
                  border: none;
                  border-radius: 8px;
                  font-size: 14px;
                  font-weight: 600;
                  cursor: pointer;
                  transition: all 0.3s ease;
            }

            .btn-primary {
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white;
            }

            .btn-primary:hover {
                  transform: translateY(-2px);
                  box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
            }

            .btn-secondary {
                  background: rgba(255, 255, 255, 0.1);
                  color: white;
                  margin-left: 10px;
            }

            .btn-secondary:hover {
                  background: rgba(255, 255, 255, 0.2);
            }

            .add-position-btn {
                  position: fixed;
                  bottom: 2rem;
                  right: 2rem;
                  width: 60px;
                  height: 60px;
                  border-radius: 50%;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white;
                  font-size: 24px;
                  border: none;
                  cursor: pointer;
                  box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
                  transition: all 0.3s ease;
                  z-index: 100;
            }

            .add-position-btn:hover {
                  transform: scale(1.1);
                  box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
            }

            .delete-position-btn {
                  background: rgba(239, 68, 68, 0.2);
                  color: #ef4444;
                  border: 1px solid #ef4444;
                  padding: 4px 8px;
                  font-size: 12px;
                  margin-top: 8px;
                  width: 48%;
                  display: inline-block;
            }

            .delete-position-btn:hover {
                  background: rgba(239, 68, 68, 0.3);
            }

            .edit-position-btn {
                  background: rgba(102, 126, 234, 0.2);
                  color: #667eea;
                  border: 1px solid #667eea;
                  padding: 4px 8px;
                  font-size: 12px;
                  margin-top: 8px;
                  width: 48%;
                  display: inline-block;
                  cursor: pointer;
            }

            .edit-position-btn:hover {
                  background: rgba(102, 126, 234, 0.3);
            }

            .position-actions {
                  display: flex;
                  gap: 4%;
                  margin-top: 8px;
            }

            /* Positions Manager Table */
            .positions-table {
                  width: 100%;
                  border-collapse: collapse;
                  margin: 1rem 0;
            }

            .positions-table th,
            .positions-table td {
                  padding: 12px;
                  text-align: left;
                  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .positions-table th {
                  background: rgba(102, 126, 234, 0.2);
                  color: rgba(255, 255, 255, 0.9);
                  font-weight: 600;
                  font-size: 14px;
            }

            .positions-table td {
                  color: rgba(255, 255, 255, 0.8);
                  font-size: 14px;
            }

            .positions-table tr:hover {
                  background: rgba(255, 255, 255, 0.05);
            }

            .positions-table .profit-cell.positive {
                  color: #10b981;
                  font-weight: 600;
            }

            .positions-table .profit-cell.negative {
                  color: #ef4444;
                  font-weight: 600;
            }

            .positions-table tfoot td {
                  font-weight: 700;
                  font-size: 15px;
                  color: white;
                  background: rgba(102, 126, 234, 0.1);
                  border-top: 2px solid rgba(102, 126, 234, 0.3);
            }

            .position-action-btn {
                  padding: 6px 12px;
                  margin: 0 4px;
                  font-size: 12px;
                  border-radius: 6px;
                  cursor: pointer;
                  border: none;
                  transition: all 0.2s ease;
            }

            .position-action-btn.edit {
                  background: rgba(102, 126, 234, 0.2);
                  color: #667eea;
                  border: 1px solid #667eea;
            }

            .position-action-btn.edit:hover {
                  background: rgba(102, 126, 234, 0.3);
            }

            .position-action-btn.delete {
                  background: rgba(239, 68, 68, 0.2);
                  color: #ef4444;
                  border: 1px solid #ef4444;
            }

            .position-action-btn.delete:hover {
                  background: rgba(239, 68, 68, 0.3);
            }
      </style>
</head>

<body>
      <div class="background-orb"></div>
      <div class="background-orb two"></div>

      <div class="container">
            <a href="index.html" class="back-btn">‚Üê Retour au Control Center</a>

            <div class="crypto-header">
                  <div>
                        <h1>üìà Actions (Stocks)</h1>
                        <p>Suivi de votre portefeuille boursier</p>
                  </div>
                  <button id="addCryptoBtn" class="add-btn" onclick="openSearchModal()"
                        style="margin-right: 10px; background: rgba(52, 211, 153, 0.2); color: #34d399; border: 1px solid #34d399; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.2s;">
                        ‚ûï Ajouter Action
                  </button>
                  <button id="updateBtn" class="update-btn" onclick="updateData()">
                        üîÑ Mettre √† jour
                  </button>
            </div>

            <!-- Filters -->
            <div class="filters-bar">
                  <div class="filter-group">
                        <label>Type:</label>
                        <select id="filterType" onchange="applyFilters()">
                              <option value="">Tous</option>
                              <option value="top50">Top 50</option>
                              <option value="watchlist">Ma Watchlist</option>
                              <option value="portfolio">üíº Mon Portfolio</option>
                        </select>
                  </div>

                  <div class="filter-group">
                        <label>Cat√©gorie:</label>
                        <select id="filterCategory" onchange="applyFilters()">
                              <option value="">Toutes</option>
                              <option value="DeFi">DeFi</option>
                              <option value="L1">Layer 1</option>
                              <option value="L2">Layer 2</option>
                              <option value="Infrastructure">Infrastructure</option>
                              <option value="Stablecoin">Stablecoin</option>
                              <option value="Other">Autre</option>
                        </select>
                  </div>

                  <div class="filter-group">
                        <label>Score:</label>
                        <select id="filterScore" onchange="applyFilters()">
                              <option value="">Tous</option>
                              <option value="high">‚â• 20 (ACCUMULER)</option>
                              <option value="medium">15-20 (OBSERVER)</option>
                              <option value="low">
                                    < 15 (RISKOFF)</option>
                        </select>
                  </div>

                  <div class="filter-group search-group">
                        <label>üîç</label>
                        <input type="text" id="searchInput" placeholder="Rechercher..." oninput="applyFilters()">
                  </div>
            </div>

            <!-- Portfolio Summary -->
            <div id="portfolioSummary" class="portfolio-summary" style="display: none;">
                  <div class="summary-card">
                        <div class="summary-label">üí∞ Investi Total</div>
                        <div class="summary-value" id="totalInvested">$0.00</div>
                  </div>
                  <div class="summary-card">
                        <div class="summary-label">üìä Valeur Actuelle</div>
                        <div class="summary-value" id="totalValue">$0.00</div>
                  </div>
                  <div class="summary-card" id="profitLossCard">
                        <div class="summary-label">üìà Gain/Perte</div>
                        <div class="summary-value" id="totalProfitLoss">$0.00 (0%)</div>
                  </div>
            </div>

            <div class="status-bar">
                  <div class="status-item">
                        <div class="status-label">Assets suivis</div>
                        <div class="status-value" id="totalAssets">-</div>
                  </div>
                  <div class="status-item">
                        <div class="status-label">Derni√®re MAJ</div>
                        <div class="status-value" id="lastUpdate">-</div>
                  </div>
                  <div class="status-item">
                        <div class="status-label">Score moyen</div>
                        <div class="status-value" id="avgScore">-</div>
                  </div>
            </div>

            <div id="content">
                  <div class="loading">
                        <div class="spinner"></div>
                        <p>Chargement des donn√©es...</p>
                  </div>
            </div>
      </div>

      <!-- Add Position Modal -->
      <div id="positionModal" class="modal">
            <div class="modal-content">
                  <div class="modal-header">
                        <h2 id="modalTitle">‚ûï Ajouter une Position</h2>
                        <span class="close-btn" onclick="closeModal()">&times;</span>
                  </div>
                  <form id="positionForm" onsubmit="submitPosition(event)">
                        <input type="hidden" id="positionId">
                        <div class="form-group">
                              <label>Crypto *</label>
                              <select id="symbolSelect" required>
                                    <option value="">S√©lectionner...</option>
                              </select>
                        </div>
                        <div class="form-group">
                              <label>Quantit√© *</label>
                              <input type="number" id="quantityInput" step="0.00000001" min="0" required
                                    placeholder="Ex: 0.5">
                        </div>
                        <div class="form-group">
                              <label>Prix d'achat (USD) *</label>
                              <input type="number" id="priceInput" step="0.01" min="0" required
                                    placeholder="Ex: 2000.00">
                        </div>
                        <div class="form-group">
                              <label>Date d'achat *</label>
                              <input type="date" id="dateInput" required>
                        </div>
                        <div class="form-group">
                              <label>Notes (optionnel)</label>
                              <textarea id="notesInput" rows="3" placeholder="Ex: Achat DCA mensuel"></textarea>
                        </div>
                        <div>
                              <button type="submit" class="btn btn-primary" id="submitBtn">Ajouter</button>
                              <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
                        </div>
                  </form>
            </div>
      </div>

      <!-- Positions Manager Modal -->
      <div id="positionsManagerModal" class="modal">
            <div class="modal-content" style="max-width: 1000px;">
                  <div class="modal-header">
                        <h2 id="managerModalTitle">üìã G√©rer les Positions</h2>
                        <span class="close-btn" onclick="closePositionsManager()">&times;</span>
                  </div>

                  <div id="positionsTableContainer">
                        <!-- Table will be dynamically generated -->
                  </div>

                  <div style="margin-top: 1.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <button class="btn btn-primary" onclick="addNewPositionForSymbol()">
                              ‚ûï Ajouter une position
                        </button>
                        <button class="btn btn-secondary" onclick="closePositionsManager()">
                              Fermer
                        </button>
                  </div>
            </div>
      </div>

      <!-- Search Crypto Modal -->
      <div id="searchModal" class="modal">
            <div class="modal-content">
                  <div class="modal-header">
                        <h2>üîç Rechercher une Action</h2>
                        <span class="close-btn" onclick="closeSearchModal()">&times;</span>
                  </div>
                  <div class="form-group">
                        <input type="text" id="coinSearchInput"
                              placeholder="Nom (ex: Apple) ou Ticker officiel (ex: AAPL, MC.PA)"
                              style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; font-size: 16px;"
                              oninput="debounceSearch()">
                        <p style="font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 8px; font-style: italic;">
                              ‚ÑπÔ∏è Si la recherche par nom √©choue (blocage API), essayez le <strong>Ticker exact</strong>
                              (ex: <code>MC.PA</code> pour LVMH, <code>TTE.PA</code> pour Total).
                        </p>
                  </div>
                  <div id="searchResults" style="max-height: 400px; overflow-y: auto; margin-top: 1rem;">
                        <!-- Results will appear here -->
                  </div>
            </div>
      </div>

      <!-- Floating Add Button -->
      <button class="add-position-btn" onclick="openModal()" title="Ajouter une position">+</button>

      <script>
            const API_BASE = 'http://localhost:8000';
            let allAssets = []; // Store all assets for client-side filtering
            let portfolioPositions = {}; // Store positions by symbol

            async function loadDashboard() {
                  try {
                        const response = await fetch(`${API_BASE}/stocks/dashboard`);
                        const data = await response.json();

                        // Store all assets
                        allAssets = data.assets;

                        // Update status bar
                        document.getElementById('totalAssets').textContent = allAssets.length;
                        document.getElementById('lastUpdate').textContent = new Date(data.updated_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                        const avgScore = allAssets
                              .filter(a => a.total_score)
                              .reduce((sum, a) => sum + a.total_score, 0) / allAssets.filter(a => a.total_score).length;
                        document.getElementById('avgScore').textContent = avgScore ? avgScore.toFixed(1) : '-';

                        // Load portfolio
                        await loadPortfolio(data.positions);

                        // Apply filters
                        applyFilters();
                  } catch (error) {
                        document.getElementById('content').innerHTML = `
                    <div class="loading">
                        <p style="color: #ef4444;">‚ùå Erreur de chargement</p>
                        <p style="font-size: 14px; color: rgba(255,255,255,0.6);">${error.message}</p>
                    </div>
                `;
                  }
            }

            async function loadPortfolio(positionsData) {
                  // positionsData is passed directly from dashboard API
                  const positionsBySymbol = {};
                  (positionsData || []).forEach(pos => {
                        if (!positionsBySymbol[pos.symbol]) {
                              positionsBySymbol[pos.symbol] = [];
                        }
                        positionsBySymbol[pos.symbol].push(pos);
                  });

                  // Calculate aggregated values for each symbol
                  portfolioPositions = {};
                  Object.keys(positionsBySymbol).forEach(symbol => {
                        const positions = positionsBySymbol[symbol];
                        const aggregated = {
                              symbol: symbol,
                              positions: positions,
                              total_quantity: positions.reduce((sum, p) => sum + parseFloat(p.quantity), 0),
                              total_invested: positions.reduce((sum, p) => sum + parseFloat(p.invested_amount), 0),
                              // Current value: qty * current_price (from positions query or asset price)
                              count: positions.length
                        };

                        // Note: Backend positions query already calculates current_value and PnL based on latest metrics
                        aggregated.total_current_value = positions.reduce((sum, p) => sum + parseFloat(p.current_value || 0), 0);
                        aggregated.total_profit_loss = positions.reduce((sum, p) => sum + parseFloat(p.pnl || 0), 0);

                        aggregated.total_profit_loss_percent = aggregated.total_invested > 0
                              ? (aggregated.total_profit_loss / aggregated.total_invested) * 100
                              : 0;
                        portfolioPositions[symbol] = aggregated;
                  });

                  // Update portfolio summary if there are positions
                  if (positionsData && positionsData.length > 0) {
                        const totalInvested = Object.values(portfolioPositions).reduce((sum, p) => sum + p.total_invested, 0);
                        const totalValue = Object.values(portfolioPositions).reduce((sum, p) => sum + p.total_current_value, 0);
                        const totalPL = totalValue - totalInvested;
                        const totalPLPercent = totalInvested > 0 ? (totalPL / totalInvested) * 100 : 0;

                        document.getElementById('portfolioSummary').style.display = 'grid';
                        document.getElementById('totalInvested').textContent = `$${totalInvested.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                        document.getElementById('totalValue').textContent = `$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                        const profitLossCard = document.getElementById('profitLossCard');
                        const profitLossText = `${totalPL >= 0 ? '+' : ''}$${Math.abs(totalPL).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} (${totalPL >= 0 ? '+' : ''}${totalPLPercent.toFixed(2)}%)`;

                        document.getElementById('totalProfitLoss').textContent = profitLossText;
                        profitLossCard.className = 'summary-card ' + (totalPL >= 0 ? 'positive' : 'negative');
                  } else {
                        document.getElementById('portfolioSummary').style.display = 'none';
                  }
            }

            // Simplified apply filters (removed score logic for now)
            function applyFilters() {
                  const filterType = document.getElementById('filterType').value;
                  const filterCategory = document.getElementById('filterCategory').value;
                  const searchTerm = document.getElementById('searchInput').value.toLowerCase();

                  let filtered = allAssets;

                  if (filterType === 'portfolio') {
                        filtered = filtered.filter(a => portfolioPositions[a.symbol]);
                  }

                  if (filterCategory) {
                        filtered = filtered.filter(a => a.sector === filterCategory); // Use sector for stocks
                  }

                  if (searchTerm) {
                        filtered = filtered.filter(a =>
                              a.symbol.toLowerCase().includes(searchTerm) ||
                              a.name.toLowerCase().includes(searchTerm)
                        );
                  }

                  renderAssets(filtered);
            }

            function renderAssets(assets) {
                  const content = document.getElementById('content');
                  content.innerHTML = '<div class="crypto-grid"></div>';
                  const grid = content.querySelector('.crypto-grid');

                  if (assets.length === 0) {
                        content.innerHTML = `
                              <div class="loading">
                                    <p style="color: rgba(255,255,255,0.6);">Aucun r√©sultat trouv√©</p>
                              </div>
                        `;
                        return;
                  }

                  assets
                        .sort((a, b) => a.symbol.localeCompare(b.symbol))
                        .forEach(asset => {
                              const card = document.createElement('div');
                              card.className = 'crypto-card';

                              const price = asset.price ? `$${asset.price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : 'N/A';

                              // Check if user has a position
                              const position = portfolioPositions[asset.symbol];
                              let positionHTML = '';

                              if (position) {
                                    const profitLoss = position.total_profit_loss || 0;
                                    const profitLossPercent = position.total_profit_loss_percent || 0;
                                    const profitClass = profitLoss >= 0 ? 'positive' : 'negative';
                                    const positionCount = position.count || 1;
                                    const positionLabel = positionCount > 1 ? ` (${positionCount} positions)` : '';

                                    positionHTML = `
                                          <div class="position-indicator">
                                                <div class="invested">Investi: $${position.total_invested.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}${positionLabel}</div>
                                                <div class="current">Valeur: $${position.total_current_value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                                                <div class="profit ${profitClass}">${profitLoss >= 0 ? '+' : ''}$${Math.abs(profitLoss).toFixed(2)} (${profitLoss >= 0 ? '+' : ''}${profitLossPercent.toFixed(2)}%)</div>
                                                <div class="position-actions">
                                                      <button class="btn edit-position-btn" onclick="event.stopPropagation(); showPositionsList('${asset.symbol}')">üìã G√©rer (${positionCount})</button>
                                                      <button class="btn delete-position-btn" onclick="event.stopPropagation(); deleteAllPositions('${asset.symbol}')">üóëÔ∏è Supprimer</button>
                                                </div>
                                          </div>
                                    `;
                              }

                              const peRatio = asset.pe_ratio ? asset.pe_ratio.toFixed(2) : '-';
                              const divYield = asset.dividend_yield ? (asset.dividend_yield * 100).toFixed(2) + '%' : '-';

                              card.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div class="crypto-symbol">${asset.symbol}</div>
                                <span style="font-size: 12px; opacity:0.7;">${asset.currency || 'USD'}</span>
                            </div>
                            <div class="crypto-name">${asset.name} ‚Ä¢ ${asset.sector || 'N/A'}</div>
                            <div class="crypto-price">${price}</div>
                            <div class="crypto-score">
                                <div>
                                    <div class="status-label">P/E Ratio</div>
                                    <div class="score-value">${peRatio}</div>
                                </div>
                                <div>
                                    <div class="status-label">Div. Yield</div>
                                    <div class="score-value">${divYield}</div>
                                </div>
                            </div>
                            ${positionHTML}
                        `;
                              grid.appendChild(card);
                        });
            }

            async function updateData() {
                  // For stocks, we just reload the dashboard which fetches latest data
                  loadDashboard();
            }
            // Load dashboard on page load
            loadDashboard();

            // Auto-refresh every 60 seconds
            setInterval(loadDashboard, 60000);

            // Modal functions
            function openModal() {
                  // Reset to add mode
                  document.getElementById('positionId').value = '';
                  document.getElementById('modalTitle').textContent = '‚ûï Ajouter une Position';
                  document.getElementById('submitBtn').textContent = 'Ajouter';
                  document.getElementById('symbolSelect').disabled = false;

                  document.getElementById('positionModal').style.display = 'block';
                  populateCryptoSelect();
                  // Set default date to today
                  document.getElementById('dateInput').valueAsDate = new Date();
            }

            function closeModal() {
                  document.getElementById('positionModal').style.display = 'none';
                  document.getElementById('positionForm').reset();
                  document.getElementById('positionId').value = '';
                  document.getElementById('symbolSelect').disabled = false;
            }

            function populateCryptoSelect() {
                  const select = document.getElementById('symbolSelect');
                  select.innerHTML = '<option value="">S√©lectionner...</option>';

                  // Sort assets alphabetically
                  const sortedAssets = [...allAssets].sort((a, b) => a.symbol.localeCompare(b.symbol));

                  sortedAssets.forEach(asset => {
                        const option = document.createElement('option');
                        option.value = asset.symbol;
                        option.textContent = `${asset.symbol} - ${asset.name}`;
                        select.appendChild(option);
                  });
            }

            async function submitPosition(event) {
                  event.preventDefault();

                  const positionId = document.getElementById('positionId').value;
                  const symbol = document.getElementById('symbolSelect').value;
                  const quantity = parseFloat(document.getElementById('quantityInput').value);
                  const price = parseFloat(document.getElementById('priceInput').value);
                  const date = document.getElementById('dateInput').value;
                  const notes = document.getElementById('notesInput').value;

                  // Determine if we're adding or updating
                  if (positionId) {
                        await updatePosition(positionId, symbol, quantity, price, date, notes);
                  } else {
                        await addPosition(symbol, quantity, price, date, notes);
                  }
            }

            async function addPosition(symbol, quantity, price, date, notes) {
                  try {
                        const response = await fetch(`${API_BASE}/stocks/positions`, {
                              method: 'POST',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                    symbol,
                                    quantity,
                                    price,
                                    date,
                                    notes: notes || null
                              })
                        });

                        if (!response.ok) {
                              const error = await response.json();
                              throw new Error(error.detail || 'Erreur lors de l\'ajout');
                        }

                        const result = await response.json();
                        console.log('Position ajout√©e:', result);

                        // Close modal and reload
                        closeModal();
                        await loadPortfolio();
                        applyFilters();

                        alert(`‚úÖ Position ajout√©e: ${quantity} ${symbol} @ $${price}`);
                  } catch (error) {
                        console.error('Error adding position:', error);
                        alert(`‚ùå Erreur: ${error.message}`);
                  }
            }

            async function deletePosition(positionId, symbol) {
                  if (!confirm(`Supprimer la position ${symbol} ?`)) {
                        return;
                  }

                  try {
                        const response = await fetch(`${API_BASE}/crypto/portfolio/positions/${positionId}`, {
                              method: 'DELETE'
                        });

                        if (!response.ok) {
                              throw new Error('Erreur lors de la suppression');
                        }

                        console.log('Position supprim√©e:', positionId);

                        // Reload portfolio
                        await loadPortfolio();
                        applyFilters();

                        alert(`‚úÖ Position ${symbol} supprim√©e`);
                  } catch (error) {
                        console.error('Error deleting position:', error);
                        alert(`‚ùå Erreur: ${error.message}`);
                  }
            }

            let currentManagedSymbol = null; // Track which symbol is being managed

            async function showPositionsList(symbol) {
                  const aggregated = portfolioPositions[symbol];
                  if (!aggregated || !aggregated.positions) return;

                  const positions = aggregated.positions;
                  currentManagedSymbol = symbol;

                  // Update modal title
                  document.getElementById('managerModalTitle').textContent = `üìã G√©rer les Positions - ${symbol}`;

                  // Generate table HTML
                  let tableHTML = `
                        <table class="positions-table">
                              <thead>
                                    <tr>
                                          <th>Date</th>
                                          <th>Quantit√©</th>
                                          <th>Prix d'achat</th>
                                          <th>Investi</th>
                                          <th>Valeur actuelle</th>
                                          <th>P/L</th>
                                          <th>Actions</th>
                                    </tr>
                              </thead>
                              <tbody>
                  `;

                  // Add rows for each position
                  positions.forEach(pos => {
                        const profitLoss = pos.profit_loss_usd || 0;
                        const profitLossPercent = pos.profit_loss_percent || 0;
                        const profitClass = profitLoss >= 0 ? 'positive' : 'negative';
                        const formattedDate = new Date(pos.purchase_date).toLocaleDateString('fr-FR');

                        tableHTML += `
                              <tr>
                                    <td>${formattedDate}</td>
                                    <td>${pos.quantity.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 8 })}</td>
                                    <td>$${pos.purchase_price_usd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td>$${pos.invested_amount_usd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td>$${(pos.current_value_usd || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                    <td class="profit-cell ${profitClass}">
                                          ${profitLoss >= 0 ? '+' : ''}$${Math.abs(profitLoss).toFixed(2)}
                                          (${profitLoss >= 0 ? '+' : ''}${profitLossPercent.toFixed(2)}%)
                                    </td>
                                    <td>
                                          <button class="position-action-btn edit" onclick="openEditModal(${pos.id}, '${symbol}')">‚úèÔ∏è Modifier</button>
                                          <button class="position-action-btn delete" onclick="deletePosition(${pos.id}, '${symbol}')">üóëÔ∏è</button>
                                    </td>
                              </tr>
                        `;
                  });

                  // Add totals footer
                  const totalProfitLoss = aggregated.total_profit_loss || 0;
                  const totalProfitLossPercent = aggregated.total_profit_loss_percent || 0;
                  const totalProfitClass = totalProfitLoss >= 0 ? 'positive' : 'negative';

                  tableHTML += `
                              </tbody>
                              <tfoot>
                                    <tr>
                                          <td colspan="3"><strong>TOTAL (${positions.length} position${positions.length > 1 ? 's' : ''})</strong></td>
                                          <td><strong>$${aggregated.total_invested.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></td>
                                          <td><strong>$${aggregated.total_current_value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></td>
                                          <td class="profit-cell ${totalProfitClass}">
                                                <strong>${totalProfitLoss >= 0 ? '+' : ''}$${Math.abs(totalProfitLoss).toFixed(2)}
                                                (${totalProfitLoss >= 0 ? '+' : ''}${totalProfitLossPercent.toFixed(2)}%)</strong>
                                          </td>
                                          <td></td>
                                    </tr>
                              </tfoot>
                        </table>
                  `;

                  // Insert table into modal
                  document.getElementById('positionsTableContainer').innerHTML = tableHTML;

                  // Show modal
                  document.getElementById('positionsManagerModal').style.display = 'block';
            }

            function closePositionsManager() {
                  document.getElementById('positionsManagerModal').style.display = 'none';
                  document.getElementById('positionsTableContainer').innerHTML = '';
                  currentManagedSymbol = null;
            }

            function addNewPositionForSymbol() {
                  if (!currentManagedSymbol) return;

                  // Close positions manager
                  closePositionsManager();

                  // Open add position modal with pre-filled symbol
                  document.getElementById('positionId').value = '';
                  document.getElementById('modalTitle').textContent = '‚ûï Ajouter une Position';
                  document.getElementById('submitBtn').textContent = 'Ajouter';

                  populateCryptoSelect();
                  document.getElementById('symbolSelect').value = currentManagedSymbol;
                  document.getElementById('symbolSelect').disabled = true; // Lock to current symbol

                  document.getElementById('positionModal').style.display = 'block';
                  document.getElementById('dateInput').valueAsDate = new Date();
            }

            async function deleteAllPositions(symbol) {
                  const aggregated = portfolioPositions[symbol];
                  if (!aggregated || !aggregated.positions) return;

                  const count = aggregated.positions.length;
                  const confirmMsg = count > 1
                        ? `Supprimer toutes les ${count} positions ${symbol} ?`
                        : `Supprimer la position ${symbol} ?`;

                  if (!confirm(confirmMsg)) return;

                  try {
                        // Delete all positions for this symbol
                        await Promise.all(aggregated.positions.map(pos =>
                              fetch(`${API_BASE}/crypto/portfolio/positions/${pos.id}`, { method: 'DELETE' })
                        ));

                        await loadPortfolio();
                        applyFilters();
                        alert(`‚úÖ ${count} position(s) ${symbol} supprim√©e(s)`);
                  } catch (error) {
                        console.error('Error deleting positions:', error);
                        alert(`‚ùå Erreur lors de la suppression`);
                  }
            }

            function openEditModal(positionId, symbol) {
                  // Get aggregated position data
                  const aggregated = portfolioPositions[symbol];
                  if (!aggregated || !aggregated.positions) {
                        alert('‚ùå Position introuvable');
                        return;
                  }

                  // Find the specific position by ID
                  const position = aggregated.positions.find(p => p.id === positionId);
                  if (!position) {
                        alert('‚ùå Position introuvable');
                        return;
                  }

                  // Set modal to edit mode
                  document.getElementById('positionId').value = positionId;
                  document.getElementById('modalTitle').textContent = '‚úèÔ∏è Modifier la Position';
                  document.getElementById('submitBtn').textContent = 'Modifier';

                  // Populate form with current values
                  populateCryptoSelect();
                  document.getElementById('symbolSelect').value = symbol;
                  document.getElementById('symbolSelect').disabled = true; // Can't change crypto
                  document.getElementById('quantityInput').value = position.quantity;
                  document.getElementById('priceInput').value = position.purchase_price_usd;
                  document.getElementById('dateInput').value = position.purchase_date;
                  document.getElementById('notesInput').value = position.notes || '';

                  // Show modal
                  document.getElementById('positionModal').style.display = 'block';
            }

            async function updatePosition(positionId, symbol, quantity, price, date, notes) {
                  try {
                        const response = await fetch(`${API_BASE}/crypto/portfolio/positions/${positionId}`, {
                              method: 'PUT',
                              headers: { 'Content-Type': 'application/json' },
                              body: JSON.stringify({
                                    quantity,
                                    purchase_price_usd: price,
                                    purchase_date: date,
                                    notes: notes || null
                              })
                        });

                        if (!response.ok) {
                              const error = await response.json();
                              throw new Error(error.detail || 'Erreur lors de la modification');
                        }

                        const result = await response.json();
                        console.log('Position modifi√©e:', result);

                        // Close modal and reload
                        closeModal();
                        await loadPortfolio();
                        applyFilters();

                        alert(`‚úÖ Position modifi√©e: ${quantity} ${symbol} @ $${price}`);
                  } catch (error) {
                        console.error('Error updating position:', error);
                        alert(`‚ùå Erreur: ${error.message}`);
                  }
            }

            // Search Modal Functions
            let searchTimeout;

            function openSearchModal() {
                  document.getElementById('searchModal').style.display = 'block';
                  document.getElementById('coinSearchInput').focus();
            }

            function closeSearchModal() {
                  document.getElementById('searchModal').style.display = 'none';
                  document.getElementById('coinSearchInput').value = '';
                  document.getElementById('searchResults').innerHTML = '';
            }

            function debounceSearch() {
                  clearTimeout(searchTimeout);
                  searchTimeout = setTimeout(searchCoins, 500);
            }

            async function searchCoins() {
                  const query = document.getElementById('coinSearchInput').value.trim();
                  const resultsDiv = document.getElementById('searchResults');

                  if (query.length < 2) {
                        resultsDiv.innerHTML = '';
                        return;
                  }

                  resultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

                  try {
                        const response = await fetch(`${API_BASE}/stocks/search?query=${query}`);
                        const data = await response.json();

                        if (!data.results || data.results.length === 0) {
                              resultsDiv.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.5);">Aucun r√©sultat trouv√©</p>';
                              return;
                        }

                        let html = '<div class="search-results-list" style="display: flex; flex-direction: column; gap: 10px;">';

                        data.results.forEach(coin => {
                              // Check if already in our assets
                              const existing = allAssets.find(a =>
                                    (a.symbol.toLowerCase() === coin.symbol.toLowerCase())
                              );

                              const isAdded = !!existing;
                              const btnText = isAdded ? 'd√©j√† ajout√©' : 'Ajouter';
                              const btnClass = isAdded ? 'btn-secondary' : 'btn-primary';
                              const btnAction = isAdded ? '' : `onclick="addCoinToWatchlist('${coin.id}', '${coin.symbol}', '${coin.name}', this)"`;
                              const btnStyle = isAdded ? 'opacity: 0.5; cursor: default;' : '';

                              html += `
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                          <div style="display: flex; align-items: center; gap: 10px;">
                                                <img src="${coin.thumb}" alt="${coin.symbol}" style="width: 24px; height: 24px; border-radius: 50%;">
                                                <div>
                                                      <div style="font-weight: bold;">${coin.name}</div>
                                                      <div style="font-size: 12px; color: rgba(255,255,255,0.6);">${coin.symbol} #${coin.market_cap_rank || '?'}</div>
                                                </div>
                                          </div>
                                          <button class="btn ${btnClass}" style="padding: 5px 10px; font-size: 12px; ${btnStyle}" ${btnAction}>
                                                ${btnText}
                                          </button>
                                    </div>
                              `;
                        });

                        html += '</div>';
                        resultsDiv.innerHTML = html;

                  } catch (error) {
                        console.error('Search error:', error);
                        resultsDiv.innerHTML = '<p style="text-align: center; color: #ef4444;">Erreur de recherche</p>';
                  }
            }

            async function addCoinToWatchlist(id, symbol, name, btn) {
                  try {
                        const response = await fetch(`${API_BASE}/stocks/watchlist/add?symbol=${symbol}&name=${name}&coingecko_id=${id}&category=Other`, {
                              method: 'POST'
                        });

                        if (!response.ok) throw new Error('Erreur ajout');

                        // Update UI row to show added
                        // const btn = event.target; // btn passed as arg
                        btn.textContent = 'Ajout√© !';
                        btn.className = 'btn btn-secondary';
                        btn.disabled = true;

                        // Refresh dashboard
                        await updateData(); // Trigger full update to get price/metrics for new asset

                  } catch (error) {
                        alert('Erreur lors de l\'ajout: ' + error.message);
                  }
            }

            // Close modal when clicking outside
            window.onclick = function (event) {
                  const positionModal = document.getElementById('positionModal');
                  const managerModal = document.getElementById('positionsManagerModal');
                  const searchModal = document.getElementById('searchModal');

                  if (event.target === positionModal) closeModal();
                  if (event.target === managerModal) closePositionsManager();
                  if (event.target === searchModal) closeSearchModal();
            }
      </script>
</body>

</html>