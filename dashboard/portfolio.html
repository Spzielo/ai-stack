<!DOCTYPE html>
<html lang="fr">

<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Global Portfolio</title>
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="style.css">
      <style>
            .summary-grid {
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                  gap: 2rem;
                  margin-top: 2rem;
            }

            .asset-card {
                  background: rgba(255, 255, 255, 0.05);
                  border: 1px solid rgba(255, 255, 255, 0.1);
                  border-radius: 16px;
                  padding: 24px;
                  transition: all 0.3s ease;
                  text-decoration: none;
                  display: block;
            }

            .asset-card:hover {
                  background: rgba(255, 255, 255, 0.08);
                  transform: translateY(-4px);
            }

            .card-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 1rem;
            }

            .card-title {
                  font-size: 24px;
                  font-weight: 700;
                  color: white;
                  display: flex;
                  align-items: center;
                  gap: 12px;
            }

            .card-value {
                  font-size: 36px;
                  font-weight: 700;
                  color: white;
                  margin-bottom: 8px;
            }

            .card-sub {
                  font-size: 16px;
                  color: rgba(255, 255, 255, 0.6);
            }

            .pnl {
                  font-weight: 600;
            }

            .positive {
                  color: #10b981;
            }

            .negative {
                  color: #ef4444;
            }

            .total-section {
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  border-radius: 20px;
                  padding: 40px;
                  text-align: center;
                  margin-bottom: 3rem;
                  box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            }

            .total-label {
                  font-size: 18px;
                  color: rgba(255, 255, 255, 0.9);
                  margin-bottom: 12px;
                  font-weight: 500;
            }

            .total-amount {
                  font-size: 56px;
                  font-weight: 800;
                  color: white;
                  margin-bottom: 8px;
                  text-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            }
      </style>
</head>

<body>
      <div class="background-orb"></div>
      <div class="background-orb two"></div>

      <div class="container">
            <a href="index.html" class="back-btn"
                  style="color: rgba(255,255,255,0.6); text-decoration: none; margin-bottom: 2rem; display: inline-block;">‚Üê
                  Retour au Control Center</a>

            <div class="total-section">
                  <div class="total-label">PATRIMOINE GLOBAL</div>
                  <div class="total-amount" id="globalValue">-</div>
                  <div class="card-sub" id="globalPnl">-</div>
            </div>

            <div class="summary-grid">
                  <!-- Crypto Card -->
                  <a href="crypto.html" class="asset-card">
                        <div class="card-header">
                              <div class="card-title"><span>ü™ô</span> Crypto</div>
                              <span style="font-size: 20px;">‚ûî</span>
                        </div>
                        <div class="card-value" id="cryptoValue">-</div>
                        <div class="card-sub" id="cryptoPnl">-</div>
                  </a>

                  <!-- Stocks Card -->
                  <a href="stocks.html" class="asset-card">
                        <div class="card-header">
                              <div class="card-title"><span>üìà</span> Bourse</div>
                              <span style="font-size: 20px;">‚ûî</span>
                        </div>
                        <div class="card-value" id="stocksValue">-</div>
                        <div class="card-sub" id="stocksPnl">-</div>
                  </a>
            </div>
      </div>

      <script>
            const API_BASE = 'http://localhost:8000';

            async function loadData() {
                  try {
                        // Fetch Crypto
                        const cryptoRes = await fetch(`${API_BASE}/crypto/portfolio/positions`);
                        const cryptoData = await cryptoRes.json();

                        // Fetch Stocks
                        const stocksRes = await fetch(`${API_BASE}/stocks/dashboard`); // Contains positions
                        const stocksData = await stocksRes.json();

                        // Calculate Crypto Stats
                        const cryptoVal = cryptoData.summary ? cryptoData.summary.total_value : 0;
                        const cryptoInvested = cryptoData.summary ? cryptoData.summary.total_invested : 0;
                        const cryptoPnl = cryptoVal - cryptoInvested;
                        const cryptoPnlPercent = cryptoInvested > 0 ? (cryptoPnl / cryptoInvested) * 100 : 0;

                        // Calculate Stocks Stats
                        let stocksVal = 0;
                        let stocksInvested = 0;
                        if (stocksData.positions) {
                              // Need to aggregate similarly to stocks.html/db logic
                              // The dashboard returns flat positions but doesn't return a "summary" object like crypto endpoint does
                              // But wait, db.get_positions returns current_value field!
                              stocksData.positions.forEach(p => {
                                    stocksVal += parseFloat(p.current_value || 0);
                                    stocksInvested += parseFloat(p.invested_amount || 0);
                              });
                        }
                        const stocksPnl = stocksVal - stocksInvested;
                        const stocksPnlPercent = stocksInvested > 0 ? (stocksPnl / stocksInvested) * 100 : 0;

                        // Global Stats
                        const globalVal = cryptoVal + stocksVal;
                        const globalInvested = cryptoInvested + stocksInvested;
                        const globalPnl = globalVal - globalInvested;
                        const globalPnlPercent = globalInvested > 0 ? (globalPnl / globalInvested) * 100 : 0;

                        // Update UI
                        updateCard('crypto', cryptoVal, cryptoPnl, cryptoPnlPercent);
                        updateCard('stocks', stocksVal, stocksPnl, stocksPnlPercent);

                        document.getElementById('globalValue').textContent = formatMoney(globalVal);
                        document.getElementById('globalPnl').innerHTML = formatPnl(globalPnl, globalPnlPercent);

                  } catch (error) {
                        console.error("Error loading portfolio:", error);
                  }
            }

            function formatMoney(amount) {
                  return '$' + amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            function formatPnl(amount, percent) {
                  const sign = amount >= 0 ? '+' : '';
                  const className = amount >= 0 ? 'positive' : 'negative';
                  return `<span class="pnl ${className}">${sign}${formatMoney(Math.abs(amount))} (${sign}${percent.toFixed(2)}%)</span>`;
            }

            function updateCard(type, val, pnl, percent) {
                  document.getElementById(`${type}Value`).textContent = formatMoney(val);
                  document.getElementById(`${type}Pnl`).innerHTML = formatPnl(pnl, percent);
            }

            loadData();
      </script>
</body>

</html>