<!DOCTYPE html>
<html lang="fr">

<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Crypto One-Glance</title>
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="style.css">
      <style>
            .crypto-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 2rem;
            }

            .update-btn {
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white;
                  border: none;
                  padding: 12px 24px;
                  border-radius: 12px;
                  font-size: 16px;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }

            .update-btn:hover {
                  transform: translateY(-2px);
                  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            }

            .update-btn:disabled {
                  opacity: 0.6;
                  cursor: not-allowed;
            }

            .status-bar {
                  background: rgba(255, 255, 255, 0.05);
                  border: 1px solid rgba(255, 255, 255, 0.1);
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 2rem;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
            }

            .status-item {
                  text-align: center;
            }

            .status-label {
                  font-size: 12px;
                  color: rgba(255, 255, 255, 0.6);
                  margin-bottom: 4px;
            }

            .status-value {
                  font-size: 20px;
                  font-weight: 700;
                  color: white;
            }

            .crypto-grid {
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                  gap: 1.5rem;
                  margin-top: 2rem;
            }

            .crypto-card {
                  background: rgba(255, 255, 255, 0.05);
                  border: 1px solid rgba(255, 255, 255, 0.1);
                  border-radius: 16px;
                  padding: 20px;
                  transition: all 0.3s ease;
            }

            .crypto-card:hover {
                  background: rgba(255, 255, 255, 0.08);
                  border-color: rgba(255, 255, 255, 0.2);
                  transform: translateY(-4px);
            }

            .crypto-symbol {
                  font-size: 24px;
                  font-weight: 700;
                  margin-bottom: 8px;
            }

            .crypto-name {
                  font-size: 14px;
                  color: rgba(255, 255, 255, 0.6);
                  margin-bottom: 16px;
            }

            .crypto-price {
                  font-size: 28px;
                  font-weight: 700;
                  color: #667eea;
                  margin-bottom: 12px;
            }

            .crypto-score {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-top: 12px;
                  padding-top: 12px;
                  border-top: 1px solid rgba(255, 255, 255, 0.1);
            }

            .score-value {
                  font-size: 18px;
                  font-weight: 700;
            }

            .status-badge {
                  padding: 4px 12px;
                  border-radius: 20px;
                  font-size: 12px;
                  font-weight: 600;
            }

            .status-accumuler {
                  background: rgba(34, 197, 94, 0.2);
                  color: #22c55e;
            }

            .status-observer {
                  background: rgba(251, 191, 36, 0.2);
                  color: #fbbf24;
            }

            .status-riskoff {
                  background: rgba(239, 68, 68, 0.2);
                  color: #ef4444;
            }

            .loading {
                  text-align: center;
                  padding: 40px;
                  color: rgba(255, 255, 255, 0.6);
            }

            .spinner {
                  border: 3px solid rgba(255, 255, 255, 0.1);
                  border-top: 3px solid #667eea;
                  border-radius: 50%;
                  width: 40px;
                  height: 40px;
                  animation: spin 1s linear infinite;
                  margin: 0 auto 16px;
            }

            @keyframes spin {
                  0% {
                        transform: rotate(0deg);
                  }

                  100% {
                        transform: rotate(360deg);
                  }
            }

            .back-btn {
                  display: inline-block;
                  color: rgba(255, 255, 255, 0.6);
                  text-decoration: none;
                  margin-bottom: 2rem;
                  transition: color 0.3s ease;
            }

            .back-btn:hover {
                  color: white;
            }

            /* Override body alignment from style.css */
            body {
                  align-items: flex-start !important;
                  overflow-y: auto !important;
                  padding: 2rem 0;
            }

            .container {
                  width: 100%;
                  max-width: 1400px;
                  margin: 0 auto;
                  padding: 0 2rem;
            }

            /* Filters */
            .filters-bar {
                  background: rgba(255, 255, 255, 0.05);
                  border: 1px solid rgba(255, 255, 255, 0.1);
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 2rem;
                  display: flex;
                  gap: 16px;
                  flex-wrap: wrap;
                  align-items: center;
            }

            .filter-group {
                  display: flex;
                  align-items: center;
                  gap: 8px;
            }

            .filter-group label {
                  font-size: 14px;
                  color: rgba(255, 255, 255, 0.7);
                  font-weight: 500;
            }

            .filter-group select,
            .filter-group input {
                  background: rgba(255, 255, 255, 0.1);
                  border: 1px solid rgba(255, 255, 255, 0.2);
                  border-radius: 8px;
                  padding: 8px 12px;
                  color: white;
                  font-size: 14px;
                  min-width: 150px;
            }

            .search-group input {
                  min-width: 200px;
            }

            .filter-group select:focus,
            .filter-group input:focus {
                  outline: none;
                  border-color: #667eea;
            }

            /* Portfolio Summary */
            .portfolio-summary {
                  display: grid;
                  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                  gap: 1rem;
                  margin-bottom: 2rem;
                  padding: 1.5rem;
                  background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
                  border: 1px solid rgba(102, 126, 234, 0.3);
                  border-radius: 12px;
            }

            .summary-card {
                  text-align: center;
                  padding: 1rem;
                  background: rgba(255, 255, 255, 0.05);
                  border-radius: 8px;
                  transition: transform 0.2s ease;
            }

            .summary-card:hover {
                  transform: translateY(-2px);
            }

            .summary-card.positive {
                  background: rgba(16, 185, 129, 0.1);
                  border: 1px solid rgba(16, 185, 129, 0.3);
            }

            .summary-card.negative {
                  background: rgba(239, 68, 68, 0.1);
                  border: 1px solid rgba(239, 68, 68, 0.3);
            }

            .summary-label {
                  font-size: 14px;
                  color: rgba(255, 255, 255, 0.7);
                  margin-bottom: 8px;
            }

            .summary-value {
                  font-size: 24px;
                  font-weight: 700;
                  color: white;
            }

            .summary-card.positive .summary-value {
                  color: #10b981;
            }

            .summary-card.negative .summary-value {
                  color: #ef4444;
            }

            /* Position indicator on crypto cards */
            .position-indicator {
                  margin-top: 12px;
                  padding: 8px;
                  background: rgba(102, 126, 234, 0.1);
                  border-left: 3px solid #667eea;
                  border-radius: 4px;
                  font-size: 12px;
            }

            .position-indicator .invested {
                  color: rgba(255, 255, 255, 0.6);
                  margin-bottom: 4px;
            }

            .position-indicator .current {
                  color: rgba(255, 255, 255, 0.8);
                  margin-bottom: 4px;
            }

            .position-indicator .profit {
                  font-weight: 600;
            }

            .position-indicator .profit.positive {
                  color: #10b981;
            }

            .position-indicator .profit.negative {
                  color: #ef4444;
            }
      </style>
</head>

<body>
      <div class="background-orb"></div>
      <div class="background-orb two"></div>

      <div class="container">
            <a href="index.html" class="back-btn">‚Üê Retour au Control Center</a>

            <div class="crypto-header">
                  <div>
                        <h1>üìà Crypto One-Glance</h1>
                        <p>Suivi long terme de cryptomonnaies</p>
                  </div>
                  <button id="updateBtn" class="update-btn" onclick="updateData()">
                        üîÑ Mettre √† jour
                  </button>
            </div>

            <!-- Filters -->
            <div class="filters-bar">
                  <div class="filter-group">
                        <label>Type:</label>
                        <select id="filterType" onchange="applyFilters()">
                              <option value="">Tous</option>
                              <option value="top50">Top 50</option>
                              <option value="watchlist">Ma Watchlist</option>
                        </select>
                  </div>

                  <div class="filter-group">
                        <label>Cat√©gorie:</label>
                        <select id="filterCategory" onchange="applyFilters()">
                              <option value="">Toutes</option>
                              <option value="DeFi">DeFi</option>
                              <option value="L1">Layer 1</option>
                              <option value="L2">Layer 2</option>
                              <option value="Infrastructure">Infrastructure</option>
                              <option value="Stablecoin">Stablecoin</option>
                              <option value="Other">Autre</option>
                        </select>
                  </div>

                  <div class="filter-group">
                        <label>Score:</label>
                        <select id="filterScore" onchange="applyFilters()">
                              <option value="">Tous</option>
                              <option value="high">‚â• 20 (ACCUMULER)</option>
                              <option value="medium">15-20 (OBSERVER)</option>
                              <option value="low">
                                    < 15 (RISKOFF)</option>
                        </select>
                  </div>

                  <div class="filter-group search-group">
                        <label>üîç</label>
                        <input type="text" id="searchInput" placeholder="Rechercher..." oninput="applyFilters()">
                  </div>
            </div>

            <!-- Portfolio Summary -->
            <div id="portfolioSummary" class="portfolio-summary" style="display: none;">
                  <div class="summary-card">
                        <div class="summary-label">üí∞ Investi Total</div>
                        <div class="summary-value" id="totalInvested">$0.00</div>
                  </div>
                  <div class="summary-card">
                        <div class="summary-label">üìä Valeur Actuelle</div>
                        <div class="summary-value" id="totalValue">$0.00</div>
                  </div>
                  <div class="summary-card" id="profitLossCard">
                        <div class="summary-label">üìà Gain/Perte</div>
                        <div class="summary-value" id="totalProfitLoss">$0.00 (0%)</div>
                  </div>
            </div>

            <div class="status-bar">
                  <div class="status-item">
                        <div class="status-label">Assets suivis</div>
                        <div class="status-value" id="totalAssets">-</div>
                  </div>
                  <div class="status-item">
                        <div class="status-label">Derni√®re MAJ</div>
                        <div class="status-value" id="lastUpdate">-</div>
                  </div>
                  <div class="status-item">
                        <div class="status-label">Score moyen</div>
                        <div class="status-value" id="avgScore">-</div>
                  </div>
            </div>

            <div id="content">
                  <div class="loading">
                        <div class="spinner"></div>
                        <p>Chargement des donn√©es...</p>
                  </div>
            </div>
      </div>

      <script>
            const API_BASE = 'http://localhost:8000';
            let allAssets = []; // Store all assets for client-side filtering
            let portfolioPositions = {}; // Store positions by symbol

            async function loadDashboard() {
                  try {
                        const response = await fetch(`${API_BASE}/crypto/dashboard`);
                        const data = await response.json();

                        // Store all assets
                        allAssets = data.assets;

                        // Update status bar
                        document.getElementById('totalAssets').textContent = allAssets.length;
                        document.getElementById('lastUpdate').textContent = new Date(data.updated_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                        const avgScore = allAssets
                              .filter(a => a.total_score)
                              .reduce((sum, a) => sum + a.total_score, 0) / allAssets.filter(a => a.total_score).length;
                        document.getElementById('avgScore').textContent = avgScore ? avgScore.toFixed(1) : '-';

                        // Load portfolio
                        await loadPortfolio();

                        // Apply filters
                        applyFilters();
                  } catch (error) {
                        document.getElementById('content').innerHTML = `
                    <div class="loading">
                        <p style="color: #ef4444;">‚ùå Erreur de chargement</p>
                        <p style="font-size: 14px; color: rgba(255,255,255,0.6);">${error.message}</p>
                    </div>
                `;
                  }
            }

            async function loadPortfolio() {
                  try {
                        const response = await fetch(`${API_BASE}/crypto/portfolio/positions`);
                        const data = await response.json();

                        // Store positions by symbol for quick lookup
                        portfolioPositions = {};
                        data.positions.forEach(pos => {
                              portfolioPositions[pos.symbol] = pos;
                        });

                        // Update portfolio summary if there are positions
                        if (data.positions.length > 0) {
                              document.getElementById('portfolioSummary').style.display = 'grid';
                              document.getElementById('totalInvested').textContent = `$${data.summary.total_invested.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                              document.getElementById('totalValue').textContent = `$${data.summary.total_value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                              const profitLoss = data.summary.total_profit_loss;
                              const profitLossPercent = data.summary.total_profit_loss_percent;
                              const profitLossCard = document.getElementById('profitLossCard');
                              const profitLossText = `${profitLoss >= 0 ? '+' : ''}$${Math.abs(profitLoss).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} (${profitLoss >= 0 ? '+' : ''}${profitLossPercent.toFixed(2)}%)`;

                              document.getElementById('totalProfitLoss').textContent = profitLossText;
                              profitLossCard.className = 'summary-card ' + (profitLoss >= 0 ? 'positive' : 'negative');
                        }
                  } catch (error) {
                        console.error('Error loading portfolio:', error);
                        // Portfolio is optional, don't show error to user
                  }
            }

            function applyFilters() {
                  const filterType = document.getElementById('filterType').value;
                  const filterCategory = document.getElementById('filterCategory').value;
                  const filterScore = document.getElementById('filterScore').value;
                  const searchTerm = document.getElementById('searchInput').value.toLowerCase();

                  let filtered = allAssets;

                  // Filter by type
                  if (filterType) {
                        filtered = filtered.filter(a => a.tracking_type === filterType);
                  }

                  // Filter by category
                  if (filterCategory) {
                        filtered = filtered.filter(a => a.category === filterCategory);
                  }

                  // Filter by score
                  if (filterScore) {
                        filtered = filtered.filter(a => {
                              const score = a.total_score || 0;
                              if (filterScore === 'high') return score >= 20;
                              if (filterScore === 'medium') return score >= 15 && score < 20;
                              if (filterScore === 'low') return score < 15;
                              return true;
                        });
                  }

                  // Filter by search
                  if (searchTerm) {
                        filtered = filtered.filter(a =>
                              a.symbol.toLowerCase().includes(searchTerm) ||
                              a.name.toLowerCase().includes(searchTerm)
                        );
                  }

                  // Render filtered assets
                  renderAssets(filtered);
            }

            function renderAssets(assets) {
                  const content = document.getElementById('content');
                  content.innerHTML = '<div class="crypto-grid"></div>';
                  const grid = content.querySelector('.crypto-grid');

                  if (assets.length === 0) {
                        content.innerHTML = `
                              <div class="loading">
                                    <p style="color: rgba(255,255,255,0.6);">Aucun r√©sultat trouv√©</p>
                              </div>
                        `;
                        return;
                  }

                  assets
                        .sort((a, b) => (b.total_score || 0) - (a.total_score || 0))
                        .forEach(asset => {
                              const card = document.createElement('div');
                              card.className = 'crypto-card';

                              const statusClass = asset.status ? `status-${asset.status.toLowerCase()}` : 'status-observer';
                              const price = asset.price_usd ? `$${asset.price_usd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : 'N/A';
                              const typeLabel = asset.tracking_type === 'top50' ? 'üîù' : '‚≠ê';

                              // Check if user has a position in this asset
                              const position = portfolioPositions[asset.symbol];
                              let positionHTML = '';

                              if (position) {
                                    const profitLoss = position.profit_loss_usd || 0;
                                    const profitLossPercent = position.profit_loss_percent || 0;
                                    const profitClass = profitLoss >= 0 ? 'positive' : 'negative';

                                    positionHTML = `
                                          <div class="position-indicator">
                                                <div class="invested">Investi: $${position.invested_amount_usd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                                                <div class="current">Valeur: $${(position.current_value_usd || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                                                <div class="profit ${profitClass}">${profitLoss >= 0 ? '+' : ''}$${Math.abs(profitLoss).toFixed(2)} (${profitLoss >= 0 ? '+' : ''}${profitLossPercent.toFixed(2)}%)</div>
                                          </div>
                                    `;
                              }

                              card.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div class="crypto-symbol">${asset.symbol}</div>
                                <span style="font-size: 18px;" title="${asset.tracking_type === 'top50' ? 'Top 50' : 'Watchlist'}">${typeLabel}</span>
                            </div>
                            <div class="crypto-name">${asset.name} ‚Ä¢ ${asset.category}</div>
                            <div class="crypto-price">${price}</div>
                            <div class="crypto-score">
                                <div>
                                    <div class="status-label">Score</div>
                                    <div class="score-value">${asset.total_score ? asset.total_score.toFixed(1) : '-'}/30</div>
                                </div>
                                <div class="status-badge ${statusClass}">
                                    ${asset.status || 'N/A'}
                                </div>
                            </div>
                            ${positionHTML}
                        `;

                              card.onclick = () => window.location.href = `crypto-detail.html?symbol=${asset.symbol}`;
                              grid.appendChild(card);
                        });
            }

            async function updateData() {
                  const btn = document.getElementById('updateBtn');
                  btn.disabled = true;
                  btn.textContent = '‚è≥ Collecte en cours...';

                  try {
                        // Trigger collection
                        const collectResponse = await fetch(`${API_BASE}/crypto/trigger/collect`, {
                              method: 'POST'
                        });

                        if (!collectResponse.ok) {
                              throw new Error('Erreur lors de la collecte des donn√©es');
                        }

                        btn.textContent = '‚è≥ Calcul des scores...';

                        // Compute scores
                        const scoreResponse = await fetch(`${API_BASE}/crypto/compute/scores`, {
                              method: 'POST'
                        });

                        if (!scoreResponse.ok) {
                              throw new Error('Erreur lors du calcul des scores');
                        }

                        const scoreData = await scoreResponse.json();

                        // Success!
                        btn.textContent = '‚úÖ Mise √† jour r√©ussie';
                        setTimeout(() => {
                              btn.textContent = 'üîÑ Mettre √† jour';
                              loadDashboard(); // Reload data
                        }, 2000);

                  } catch (error) {
                        btn.textContent = '‚ùå Erreur';
                        alert('‚ùå Erreur: ' + error.message);
                        setTimeout(() => {
                              btn.textContent = 'üîÑ Mettre √† jour';
                        }, 2000);
                  } finally {
                        btn.disabled = false;
                  }
            }

            // Load dashboard on page load
            loadDashboard();

            // Auto-refresh every 60 seconds
            setInterval(loadDashboard, 60000);
      </script>
</body>

</html>