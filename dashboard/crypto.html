<!DOCTYPE html>
<html lang="fr">

<head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Crypto One-Glance</title>
      <link rel="preconnect" href="https://fonts.googleapis.com">
      <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
      <link rel="stylesheet" href="style.css">
      <style>
            .crypto-header {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-bottom: 2rem;
            }

            .update-btn {
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white;
                  border: none;
                  padding: 12px 24px;
                  border-radius: 12px;
                  font-size: 16px;
                  font-weight: 500;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            }

            .update-btn:hover {
                  transform: translateY(-2px);
                  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            }

            .update-btn:disabled {
                  opacity: 0.6;
                  cursor: not-allowed;
            }

            .status-bar {
                  background: rgba(255, 255, 255, 0.05);
                  border: 1px solid rgba(255, 255, 255, 0.1);
                  border-radius: 12px;
                  padding: 16px;
                  margin-bottom: 2rem;
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
            }

            .status-item {
                  text-align: center;
            }

            .status-label {
                  font-size: 12px;
                  color: rgba(255, 255, 255, 0.6);
                  margin-bottom: 4px;
            }

            .status-value {
                  font-size: 20px;
                  font-weight: 700;
                  color: white;
            }

            .crypto-grid {
                  display: grid;
                  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                  gap: 1.5rem;
                  margin-top: 2rem;
            }

            .crypto-card {
                  background: rgba(255, 255, 255, 0.05);
                  border: 1px solid rgba(255, 255, 255, 0.1);
                  border-radius: 16px;
                  padding: 20px;
                  transition: all 0.3s ease;
            }

            .crypto-card:hover {
                  background: rgba(255, 255, 255, 0.08);
                  border-color: rgba(255, 255, 255, 0.2);
                  transform: translateY(-4px);
            }

            .crypto-symbol {
                  font-size: 24px;
                  font-weight: 700;
                  margin-bottom: 8px;
            }

            .crypto-name {
                  font-size: 14px;
                  color: rgba(255, 255, 255, 0.6);
                  margin-bottom: 16px;
            }

            .crypto-price {
                  font-size: 28px;
                  font-weight: 700;
                  color: #667eea;
                  margin-bottom: 12px;
            }

            .crypto-score {
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                  margin-top: 12px;
                  padding-top: 12px;
                  border-top: 1px solid rgba(255, 255, 255, 0.1);
            }

            .score-value {
                  font-size: 18px;
                  font-weight: 700;
            }

            .status-badge {
                  padding: 4px 12px;
                  border-radius: 20px;
                  font-size: 12px;
                  font-weight: 600;
            }

            .status-accumuler {
                  background: rgba(34, 197, 94, 0.2);
                  color: #22c55e;
            }

            .status-observer {
                  background: rgba(251, 191, 36, 0.2);
                  color: #fbbf24;
            }

            .status-riskoff {
                  background: rgba(239, 68, 68, 0.2);
                  color: #ef4444;
            }

            .loading {
                  text-align: center;
                  padding: 40px;
                  color: rgba(255, 255, 255, 0.6);
            }

            .spinner {
                  border: 3px solid rgba(255, 255, 255, 0.1);
                  border-top: 3px solid #667eea;
                  border-radius: 50%;
                  width: 40px;
                  height: 40px;
                  animation: spin 1s linear infinite;
                  margin: 0 auto 16px;
            }

            @keyframes spin {
                  0% {
                        transform: rotate(0deg);
                  }

                  100% {
                        transform: rotate(360deg);
                  }
            }

            .back-btn {
                  display: inline-block;
                  color: rgba(255, 255, 255, 0.6);
                  text-decoration: none;
                  margin-bottom: 2rem;
                  transition: color 0.3s ease;
            }

            .back-btn:hover {
                  color: white;
            }
      </style>
</head>

<body>
      <div class="background-orb"></div>
      <div class="background-orb two"></div>

      <div class="container">
            <a href="index.html" class="back-btn">‚Üê Retour au Control Center</a>

            <div class="crypto-header">
                  <div>
                        <h1>üìà Crypto One-Glance</h1>
                        <p>Suivi long terme de cryptomonnaies</p>
                  </div>
                  <button id="updateBtn" class="update-btn" onclick="updateData()">
                        üîÑ Mettre √† jour
                  </button>
            </div>

            <div class="status-bar">
                  <div class="status-item">
                        <div class="status-label">Assets suivis</div>
                        <div class="status-value" id="totalAssets">-</div>
                  </div>
                  <div class="status-item">
                        <div class="status-label">Derni√®re MAJ</div>
                        <div class="status-value" id="lastUpdate">-</div>
                  </div>
                  <div class="status-item">
                        <div class="status-label">Score moyen</div>
                        <div class="status-value" id="avgScore">-</div>
                  </div>
            </div>

            <div id="content">
                  <div class="loading">
                        <div class="spinner"></div>
                        <p>Chargement des donn√©es...</p>
                  </div>
            </div>
      </div>

      <script>
            const API_BASE = 'http://localhost:8000';

            async function loadDashboard() {
                  try {
                        const response = await fetch(`${API_BASE}/crypto/dashboard`);
                        const data = await response.json();

                        // Update status bar
                        document.getElementById('totalAssets').textContent = data.assets.length;
                        document.getElementById('lastUpdate').textContent = new Date(data.updated_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                        const avgScore = data.assets
                              .filter(a => a.total_score)
                              .reduce((sum, a) => sum + a.total_score, 0) / data.assets.filter(a => a.total_score).length;
                        document.getElementById('avgScore').textContent = avgScore.toFixed(1);

                        // Render crypto cards
                        const content = document.getElementById('content');
                        content.innerHTML = '<div class="crypto-grid"></div>';
                        const grid = content.querySelector('.crypto-grid');

                        data.assets
                              .sort((a, b) => (b.total_score || 0) - (a.total_score || 0))
                              .forEach(asset => {
                                    const card = document.createElement('div');
                                    card.className = 'crypto-card';

                                    const statusClass = asset.status ? `status-${asset.status.toLowerCase()}` : 'status-observer';
                                    const price = asset.price_usd ? `$${asset.price_usd.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}` : 'N/A';

                                    card.innerHTML = `
                            <div class="crypto-symbol">${asset.symbol}</div>
                            <div class="crypto-name">${asset.name} ‚Ä¢ ${asset.category}</div>
                            <div class="crypto-price">${price}</div>
                            <div class="crypto-score">
                                <div>
                                    <div class="status-label">Score</div>
                                    <div class="score-value">${asset.total_score ? asset.total_score.toFixed(1) : '-'}/30</div>
                                </div>
                                <div class="status-badge ${statusClass}">
                                    ${asset.status || 'N/A'}
                                </div>
                            </div>
                        `;

                                    card.onclick = () => window.location.href = `crypto-detail.html?symbol=${asset.symbol}`;
                                    grid.appendChild(card);
                              });
                  } catch (error) {
                        document.getElementById('content').innerHTML = `
                    <div class="loading">
                        <p style="color: #ef4444;">‚ùå Erreur de chargement</p>
                        <p style="font-size: 14px; color: rgba(255,255,255,0.6);">${error.message}</p>
                    </div>
                `;
                  }
            }

            async function updateData() {
                  const btn = document.getElementById('updateBtn');
                  btn.disabled = true;
                  btn.textContent = '‚è≥ Collecte en cours...';

                  try {
                        // Trigger collection
                        const collectResponse = await fetch(`${API_BASE}/crypto/trigger/collect`, {
                              method: 'POST'
                        });

                        if (!collectResponse.ok) {
                              throw new Error('Erreur lors de la collecte des donn√©es');
                        }

                        btn.textContent = '‚è≥ Calcul des scores...';

                        // Compute scores
                        const scoreResponse = await fetch(`${API_BASE}/crypto/compute/scores`, {
                              method: 'POST'
                        });

                        if (!scoreResponse.ok) {
                              throw new Error('Erreur lors du calcul des scores');
                        }

                        const scoreData = await scoreResponse.json();

                        // Success!
                        btn.textContent = '‚úÖ Mise √† jour r√©ussie';
                        setTimeout(() => {
                              btn.textContent = 'üîÑ Mettre √† jour';
                              loadDashboard(); // Reload data
                        }, 2000);

                  } catch (error) {
                        btn.textContent = '‚ùå Erreur';
                        alert('‚ùå Erreur: ' + error.message);
                        setTimeout(() => {
                              btn.textContent = 'üîÑ Mettre √† jour';
                        }, 2000);
                  } finally {
                        btn.disabled = false;
                  }
            }

            // Load dashboard on page load
            loadDashboard();

            // Auto-refresh every 60 seconds
            setInterval(loadDashboard, 60000);
      </script>
</body>

</html>